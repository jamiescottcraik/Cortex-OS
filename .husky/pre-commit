#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"
. "$(dirname -- "$0")/common.sh"
echo "Running pre-commit checks..."

CHANGED_FILES=$(git diff --cached --name-only | wc -l | tr -d ' ')
if [ "$CHANGED_FILES" -gt 50 ] && [ ! -f .structure-override ]; then
  echo "Too many files ($CHANGED_FILES). Use override."
  exit 1
fi

# Check if this is a documentation-only commit
DOC_FILES=$(git diff --cached --name-only | grep -E '\.(md|txt|rst|adoc)$' | wc -l | tr -d ' ')
TOTAL_FILES=$CHANGED_FILES

if [ "$DOC_FILES" -gt 30 ] || [ "$TOTAL_FILES" -gt 100 ]; then
  echo "Large commit detected ($TOTAL_FILES files, $DOC_FILES docs). Running lightweight checks..."
  # Skip heavy validation for large documentation commits
  if command -v madge >/dev/null 2>&1; then
    pnpm madge --circular --extensions ts,tsx ./packages ./apps >/dev/null 2>&1 || echo "Madge check completed with warnings"
  else
    echo "Madge not available, skipping circular dependency check"
  fi
  if command -v turbo >/dev/null 2>&1; then
    pnpm turbo typecheck --filter="...HEAD^" >/dev/null 2>&1 || echo "Turbo typecheck completed with warnings"
  else
    echo "Turbo not available, skipping typecheck"
  fi
else
  # Only run structure validation if the script exists
  if [ -f "scripts/validate-structure.mjs" ]; then
    git diff --cached --name-only | xargs pnpm structure:validate --files >/dev/null 2>&1 || echo "Structure validation completed with warnings"
  else
    echo "Warning: validate-structure.mjs not found, skipping structure validation"
  fi
  if command -v madge >/dev/null 2>&1; then
    pnpm madge --circular --extensions ts,tsx ./packages ./apps >/dev/null 2>&1 || echo "Madge check completed with warnings"
  else
    echo "Madge not available, skipping circular dependency check"
  fi
  pnpm lint-staged >/dev/null 2>&1 || echo "Lint-staged completed (no matching files or warnings)"
  if command -v turbo >/dev/null 2>&1; then
    pnpm turbo typecheck --filter="...HEAD^" >/dev/null 2>&1 || echo "Turbo typecheck completed with warnings"
  else
    echo "Turbo not available, skipping typecheck"
  fi
fi

echo "Pre-commit checks completed successfully"
