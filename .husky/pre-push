#!/usr/bin/env sh
. "$(dirname -- "$0")/common.sh"

echo "Running pre-push checks..."

# Run linting
if command -v pnpm >/dev/null 2>&1; then
  echo "Running linter..."
  pnpm lint || {
    echo "❌ Linting failed"
    echo "Please fix linting issues before pushing"
    exit 1
  }
  echo "✅ Linting passed"
else
  echo "Warning: pnpm not found, skipping linting"
fi

# Run security scan if semgrep is available
if command -v semgrep >/dev/null 2>&1; then
  echo "Running security scan..."
  pnpm security:scan:all || {
    echo "❌ Security scan failed"
    echo "Please address security issues before pushing"
    exit 1
  }
  echo "✅ Security scan passed"
else
  echo "Warning: semgrep not found, skipping security scan"
fi

# Check for code changes and run appropriate security scans
if git diff --cached --name-only | grep -E '\.(js|ts|mjs|jsx|tsx|py|go|java|rb|php)$' >/dev/null; then
  echo "Code changes detected, running security scan..."
  if command -v pnpm >/dev/null 2>&1; then
    pnpm security:scan || {
      echo "❌ Security scan failed"
      echo "Please address security issues before pushing"
      exit 1
    }
    echo "✅ Security scan for code changes passed"
  fi
else
  echo "No code changes detected; skipping detailed security scan"
fi

# Run TypeScript type checking (heavy) at pre-push stage
if command -v pnpm >/dev/null 2>&1; then
  echo "Running TypeScript type checking..."
  if pnpm run | grep -q '^typecheck'; then
    pnpm typecheck || {
      echo "❌ TypeScript typecheck failed"
      exit 1
    }
  else
    echo "Skipping typecheck (script not defined)"
  fi
fi

# Run Python checks at pre-push stage if python dir exists
if [ -d python ]; then
  if command -v uv >/dev/null 2>&1; then
    echo "Running Python checks (ruff, pyright)..."
    (cd python && uv run ruff check . && uv run pyright) || {
      echo "❌ Python checks failed"
      exit 1
    }
  else
    echo "⚠️ uv not found; skipping Python checks"
  fi
fi

echo "✅ All pre-push checks passed!"
exit 0
