#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"
. "$(dirname -- "$0")/common.sh"

echo "Running pre-push checks..."

# Run linting
if command -v pnpm >/dev/null 2>&1; then
  echo "Running linter..."
  pnpm lint || {
    echo "❌ Linting failed"
    echo "Please fix linting issues before pushing"
    exit 1
  }
  echo "✅ Linting passed"
else
  echo "Warning: pnpm not found, skipping linting"
fi

# Run security scan if semgrep is available
if command -v semgrep >/dev/null 2>&1; then
  echo "Running security scan..."
  pnpm security:scan:all || {
    echo "❌ Security scan failed"
    echo "Please address security issues before pushing"
    exit 1
  }
  echo "✅ Security scan passed"
else
  echo "Warning: semgrep not found, skipping security scan"
fi

# Check for code changes and run appropriate security scans
if git diff --cached --name-only | grep -E '\.(js|ts|mjs|jsx|tsx|py|go|java|rb|php)$' >/dev/null; then
  echo "Code changes detected, running security scan..."
  if command -v pnpm >/dev/null 2>&1; then
    pnpm security:scan || {
      echo "❌ Security scan failed"
      echo "Please address security issues before pushing"
      exit 1
    }
    echo "✅ Security scan for code changes passed"
  fi
else
  echo "No code changes detected; skipping detailed security scan"
fi

echo "✅ All pre-push checks passed!"
exit 0
