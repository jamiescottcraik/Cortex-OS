#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"
. "$(dirname -- "$0")/common.sh"

# Fast lint first
pnpm lint || exit 1

if command -v semgrep >/dev/null 2>&1; then
  pnpm security:scan:all || exit 1
else
  echo "Warning: semgrep not found, skipping security scan."
fi

# Scope tests to changed packages; skip if only docs/config changed.
# Only run security scan if code files are being pushed
if git diff --cached --name-only | grep -E '\.(js|ts|mjs|jsx|tsx|py|go|java|rb|php)$' >/dev/null; then
  pnpm security:scan || exit 1
else
  echo "No code changes detected; skipping security scan."
fi
