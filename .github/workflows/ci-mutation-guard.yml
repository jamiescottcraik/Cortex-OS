name: CI Mutation Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'packages/agents/src/agents/security-agent.ts'
      - 'packages/agents/src/lib/utils.ts'
      - 'packages/agents/src/lib/validate.ts'
      - 'stryker.conf.json'
      - '.github/workflows/ci-mutation-guard.yml'

jobs:
  mutation:
    name: mutation-score
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.16.0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install deps
        run: pnpm install --frozen-lockfile --ignore-scripts
      - name: Run mutation tests
        run: pnpm mutation:enforce
        env:
          # Raised from 70 -> 75 as part of quality gate hardening.
          MUTATION_MIN: 75
      - name: Generate badges (optional)
        if: always()
        run: pnpm badges:generate || true
      - name: Upload mutation report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: reports/mutation/
