name: Security
on:
  pull_request:
  schedule:
    - cron: "0 3 * * *"
jobs:
  supply-chain:
    runs-on: ubuntu-latest
    permissions: { security-events: write }
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: astral-sh/setup-uv@v3
      - run: pnpm install --frozen-lockfile
      - run: pnpm audit --audit-level=moderate || true
      - uses: google/osv-scanner-action@v1
        with:
          scan-args: "--lockfile=pnpm-lock.yaml --lockfile=uv.lock"
      - uses: aquasecurity/trivy-action@master
        with: { scan-type: fs, scan-ref: ".", format: sarif, output: trivy-results.sarif }
      - uses: github/codeql-action/upload-sarif@v3
        with: { sarif_file: trivy-results.sarif }
      - run: |
          uv pip install bandit[toml] safety
          uv run bandit -r services/ -f json -o bandit-report.json || true
          uv run safety check --json || true
